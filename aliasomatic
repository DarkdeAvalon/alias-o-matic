#!/bin/bash

# --- CONFIGURAZIONE ---
FILE_ALIASES="$HOME/.aliasomatic"
[[ -n "$ZSH_VERSION" ]] && SHELL_RC="$HOME/.zshrc" || SHELL_RC="$HOME/.bashrc"
SCRIPT_PATH="/usr/local/bin/aliasomatic"

# --- SETUP INIZIALE ---
if ! grep -q "alias am=" "$SHELL_RC" 2>/dev/null; then
    touch "$FILE_ALIASES"
    echo -e "\n# Alias O'Matic Engine\nalias am='source $SCRIPT_PATH'" >> "$SHELL_RC"
    echo "[[ -f $FILE_ALIASES ]] && source $FILE_ALIASES" >> "$SHELL_RC"
    whiptail --title "CONFIGURAZIONE" --msgbox "Installazione completata!\nUsa 'am' per iniziare." 12 60
    return 0 2>/dev/null || exit 0
fi

# --- LOOP PRINCIPALE ---
while true; do
    CHOICE=$(whiptail --title "Alias O'Matic v1.7" \
    --menu "Scegli un'opzione (Usa le frecce o i numeri):" 16 65 6 \
    "1" "Aggiungi un nuovo alias" \
    "2" "Rimuovi un alias esistente" \
    "3" "Elenca i tuoi alias" \
    "4" "Reload globale" \
    "5" "Esci e chiudi" 3>&1 1>&2 2>&3)

    EXIT_STATUS=$?

    # --- LOGICA DI USCITA ---
    if [ $EXIT_STATUS -ne 0 ] || [ "$CHOICE" = "5" ]; then
        # Scegliamo il messaggio qui direttamente per evitare problemi di scope
        MESSAGES=("Sali sull'EVA, Socio!" "Hasta la vista!" "Omae wa mou shindeiru..." "Eclissi completata.")
        RAND_MSG=${MESSAGES[$RANDOM % ${#MESSAGES[@]}]}
        
        # Lanciamo whiptail e aspettiamo che l'utente prema OK
        whiptail --title "EXIT" --msgbox "$RAND_MSG" 8 50
        
        # Uscita pulita per 'source'
        return 0 2>/dev/null || exit 0
    fi
    
    case "$CHOICE" in
        "1")
            NAME=$(whiptail --inputbox "Nome scorciatoia:" 8 60 3>&1 1>&2 2>&3)
            [[ -z "$NAME" ]] && continue
            CMD=$(whiptail --inputbox "Comando completo:" 8 60 3>&1 1>&2 2>&3)
            [[ -z "$CMD" ]] && continue
            echo "alias $NAME='$CMD'" >> "$FILE_ALIASES"
            source "$FILE_ALIASES"
            whiptail --msgbox "Creato!" 8 40
            ;;
        "2")
            LIST=$(grep "alias " "$FILE_ALIASES" | cut -d' ' -f2 | cut -d'=' -f1)
            [[ -z "$LIST" ]] && continue
            MENU_DATA=()
            for a in $LIST; do MENU_DATA+=("$a" "[X]"); done
            TO_REMOVE=$(whiptail --menu "Elimina:" 20 60 10 "${MENU_DATA[@]}" 3>&1 1>&2 2>&3)
            if [[ -n "$TO_REMOVE" ]]; then
                sed -i "/alias $TO_REMOVE=/d" "$FILE_ALIASES"
                unalias "$TO_REMOVE" 2>/dev/null
            fi
            ;;
        "3")
            ALL=$(cat "$FILE_ALIASES")
            whiptail --title "I tuoi Alias" --msgbox "${ALL:-Vuoto.}" 20 65
            ;;
        "4")
            source "$FILE_ALIASES"
            whiptail --msgbox "Fatto!" 8 40
            ;;
    esac
done
